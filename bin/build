#!/usr/bin/env bash

BASE=$(readlink -f $(dirname $0)/..)

#------------------------------------------------------------------------
# Functions
#------------------------------------------------------------------------

run_build() {
  local image=$1
  local dockerfile=$2

  docker build -t ${REGISTRY}/${USER}/${image}:latest -f ${dockerfile} . \
    && docker push ${REGISTRY}/${USER}/${image}:latest \
    && ${SINGULARITY} build tmp/${image}.simg docker://${REGISTRY}/${USER}/${image}:latest
}

#------------------------------------------------------------------------
# Main
#------------------------------------------------------------------------

SINGULARITY=/opt/hii/singularity/2.4.2/bin/singularity
REGISTRY=registry.epi.usf.edu

if [[ $# -ne 1 ]]; then
  echo "Usage: $(basename $0) <image>" 1>&2
  echo
  ls -1 ${BASE}/Dockerfiles/ 1>&2
  exit 1
fi

image=$1

dockerfile=Dockerfiles/${image}

/bin/rm -rf ~/.singularity/docker

if ! [[ -f ${dockerfile} ]]; then
  err "Dockerfile '${dockerfile}' does not exist. exiting" 1>&2
  exit 1
fi

run_build ${image} ${dockerfile} 2>&1 | tee ${BASE}/tmp/${image}.log

echo
echo "#------------------------------------------------------------------------------"
echo "# DEPLOYMENT "
echo "#------------------------------------------------------------------------------" ]] ]]
echo
echo "# test: "
echo
echo "ssh hii.rc.usf.edu 'mkdir -p /shares/hii/images/${USER}/${image}' && rsync -vP tmp/${image}.simg hii.rc.usf.edu:/shares/hii/images/${USER}/${image}/test.simg"
echo
echo "# yyyy-mm:"
echo
echo "ssh hii.rc.usf.edu 'mkdir -p /shares/hii/images/${USER}/${image}' &&  rsync -vP ${image} hii.rc.usf.edu:/shares/hii/images/${USER}/${image}/$(date +%Y-%m).simg"
echo
echo "# update_latest:"
echo
echo "ssh hii.rc.usf.edu 'cd /shares/hii/images/$USER/${image} && ln -fs $(date +%Y-%m).simg latest.simg'"


